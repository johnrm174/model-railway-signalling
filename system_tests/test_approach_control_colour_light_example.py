from system_test_harness import *

initialise_test_harness(filename="../configuration_examples/approach_control_colour_light_example.sig")

# This Checks the default interlocking and signal states
print("Initialisation state test")
assert_signals_DANGER(1,2,3,4,5,6,7,8,12)
assert_signals_CAUTION(9,16)
assert_signals_PRELIM_CAUTION(17)
assert_signals_PROCEED(10,11,18,19)
assert_points_unlocked(2,3,5)
assert_signals_unlocked(1,3,4,5,6,7,8,12,13,15)
assert_subsidaries_unlocked(1,2,3)
assert_signals_locked(2,14)

# This clears all the signals and sends a train from Left to right along the main line
print("Main line tests 1")
sleep(1)
set_signals_off(8,1,3,4)
set_sections_occupied(10)
assert_points_locked(2,3,5)
assert_signals_locked(15,13)
assert_subsidaries_locked(1)
assert_signals_PROCEED(17,16,8,1,3,4)
assert_signals_route_MAIN(1)
sleep(1)
trigger_signals_passed(17)
assert_signals_override_set(17)
assert_sections_occupied(5)
assert_sections_clear(10)
assert_signals_DANGER(17)
sleep(1)
trigger_signals_passed(16)
assert_signals_override_set(16)
assert_sections_occupied(1)
assert_sections_clear(5)
assert_signals_DANGER(16)
assert_signals_CAUTION(17)
sleep(1)
trigger_signals_passed(8)
assert_signals_override_set(8)
assert_sections_occupied(2)
assert_sections_clear(1)
assert_signals_DANGER(8)
assert_signals_CAUTION(16)
assert_signals_PRELIM_CAUTION(17)
sleep(0.5)
trigger_signals_released(1)
sleep(0.5)
trigger_signals_passed(1)
assert_signals_override_set(1)
assert_sections_occupied(3)
assert_sections_clear(2)
assert_signals_DANGER(1)
assert_signals_CAUTION(8)
assert_signals_PRELIM_CAUTION(16)
assert_signals_PROCEED(17)
sleep(0.5)
trigger_signals_passed(15)
sleep(0.5)
trigger_signals_passed(3)
assert_signals_override_set(3)
assert_sections_occupied(4)
assert_sections_clear(3)
assert_signals_DANGER(3)
assert_signals_CAUTION(1)
assert_signals_PRELIM_CAUTION(8)
assert_signals_PROCEED(16,17)
sleep(0.5)
trigger_signals_passed(13)
sleep(0.5)
trigger_signals_passed(4)
assert_sections_clear(4)
assert_signals_DANGER(4)
assert_signals_CAUTION(3)
assert_signals_PRELIM_CAUTION(1)
assert_signals_PROCEED(8,16,17)

# This clears all the signals and sends a train from right to left along the main line
print("Main line tests 2")
sleep(1)
set_signals_off(12)
set_sections_occupied(6)
assert_points_locked(5)
assert_signals_locked(14)
assert_signals_PROCEED(9,12,10,18,19,11)
sleep(1)
trigger_signals_passed(9)
assert_signals_override_set(9)
assert_sections_occupied(7)
assert_sections_clear(6)
assert_signals_DANGER(9)
sleep(1)
trigger_signals_passed(12)
assert_signals_override_set(12)
assert_sections_occupied(8)
assert_sections_clear(7)
assert_signals_DANGER(12)
assert_signals_CAUTION(9)
sleep(0.5)
trigger_signals_passed(14)
sleep(0.5)
trigger_signals_passed(10)
assert_signals_override_set(10)
assert_sections_occupied(9)
assert_sections_clear(8)
assert_signals_DANGER(10)
assert_signals_CAUTION(12)
assert_signals_PRELIM_CAUTION(9)
sleep(1)
trigger_signals_passed(18)
assert_signals_override_set(18)
assert_sections_occupied(14)
assert_sections_clear(15)
assert_signals_DANGER(18)
assert_signals_CAUTION(10)
assert_signals_PRELIM_CAUTION(12)
assert_signals_PROCEED(9)
sleep(1)
trigger_signals_passed(19)
assert_signals_override_set(19)
assert_sections_occupied(15)
assert_sections_clear(14)
assert_signals_DANGER(19)
assert_signals_CAUTION(18)
assert_signals_PRELIM_CAUTION(10)
assert_signals_PROCEED(12,9)
sleep(1)
trigger_signals_passed(11)
assert_sections_clear(15)
assert_signals_DANGER(11)
assert_signals_CAUTION(19)
assert_signals_PRELIM_CAUTION(18)
assert_signals_PROCEED(10,12,9)

# This clears all the signals and sends a train from right to left via the loop line
# Note the loop line is subject to approach control (controlled via signal 1)
print("Loop line tests")

# Change point 1 and clear signal 1 for the new route
sleep(1)
set_signals_on(1)
sleep(1)
assert_points_unlocked(2)
set_fpls_off(2)
assert_signals_locked(1,15,6,5)
assert_subsidaries_locked(1)
set_points_switched (2)
set_fpls_on(2)
assert_signals_unlocked(1)
assert_signals_locked(5,15)
assert_subsidaries_unlocked(1)
sleep(1)
set_signals_off(1)
assert_signals_route_LH1(1)
assert_signals_locked(6,7)
assert_subsidaries_locked(1)
assert_signals_app_cntl_set(1)
# Change point 3 and clear signal 2 for the new route
sleep(1)
set_signals_on(3)
sleep(1)
assert_points_unlocked(3)
set_fpls_off(3)
assert_signals_locked(2,3,7,13)
assert_subsidaries_locked(2,3)
set_points_switched (3)
set_fpls_on(3)
assert_signals_unlocked(2)
assert_signals_locked(7,3)
assert_subsidaries_unlocked(2)
assert_subsidaries_locked(3)
sleep(1)
set_signals_off(2)
assert_signals_route_MAIN(2)
assert_signals_locked(6,7)
assert_subsidaries_locked(1)
sleep(1)
# Now feed in the first train
set_sections_occupied(10)
assert_points_locked(2,3,5)
assert_signals_locked(3,5,6,7,15,13,14)
assert_subsidaries_locked(3)
assert_signals_PROCEED(17,2)
assert_signals_CAUTION_APP_CNTL(1)
assert_signals_FLASH_CAUTION(8)
assert_signals_FLASH_PRELIM_CAUTION(16)
sleep(1)
trigger_signals_passed(17)
assert_signals_override_set(17)
assert_sections_occupied(5)
assert_sections_clear(10)
assert_signals_DANGER(17)
sleep(1)
trigger_signals_passed(16)
assert_signals_override_set(16)
assert_sections_occupied(1)
assert_sections_clear(5)
assert_signals_DANGER(16)
assert_signals_CAUTION(17)
sleep(1)
trigger_signals_passed(8)
assert_signals_override_set(8)
assert_sections_occupied(2)
assert_sections_clear(1)
assert_signals_DANGER(8)
assert_signals_CAUTION(16)
assert_signals_PRELIM_CAUTION(17)
sleep(0.5)
assert_signals_CAUTION_APP_CNTL(1)
assert_signals_app_cntl_set(1)
trigger_signals_released(1)
assert_signals_app_cntl_clear(1)
assert_signals_PROCEED(1)
assert_signals_DANGER(8)
assert_signals_CAUTION(16)
assert_signals_PRELIM_CAUTION(17)
sleep(0.5)
trigger_signals_passed(1)
assert_signals_app_cntl_set(1)
assert_signals_override_set(1)
assert_sections_occupied(12)
assert_sections_clear(2)
assert_signals_DANGER(1)
assert_signals_CAUTION(8)
assert_signals_PRELIM_CAUTION(16)
assert_signals_PROCEED(17)
sleep(0.5)
trigger_signals_passed(6)
sleep(0.5)
trigger_signals_passed(2)
assert_signals_override_set(2)
assert_sections_occupied(4)
assert_sections_clear(12)
assert_signals_DANGER(2)
assert_signals_CAUTION_APP_CNTL(1)
assert_signals_FLASH_CAUTION(8)
assert_signals_FLASH_PRELIM_CAUTION(16)
assert_signals_PROCEED(17)
sleep(0.5)
trigger_signals_passed(13)
sleep(0.5)
trigger_signals_passed(4)
assert_sections_clear(4)
assert_signals_DANGER(4)
assert_signals_CAUTION(2)
assert_signals_CAUTION_APP_CNTL(1)
assert_signals_FLASH_CAUTION(8)
assert_signals_FLASH_PRELIM_CAUTION(16)
assert_signals_PROCEED(17)

complete_tests()
